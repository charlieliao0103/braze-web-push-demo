<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Braze Final Solution</title>
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self';
                   connect-src 'self' https://*.braze.com;
                   script-src 'self' 'unsafe-inline' https://js.appboycdn.com;
                   worker-src 'self' blob:;
                   style-src 'self' 'unsafe-inline'">
    
    <!-- Braze Loader -->
    <!-- Braze Loader with Error Handling -->
    <script>
        (function(){
            var brazeLoader = document.createElement('script');
            brazeLoader.src = 'https://js.appboycdn.com/web-sdk/5.8/braze.min.js';
            brazeLoader.async = true;
            
            // Add error handler
            brazeLoader.onerror = function() {
                console.error('Braze SDK failed to load');
                updateStatus('Braze SDK load failed', 'error');
            };
            
            document.head.appendChild(brazeLoader);
        })();
    </script>

    <!-- Configuration -->
    <script type="text/javascript">
        window.brazeConfig = {
            apiKey: '84e848cb-2923-4629-bd23-e6e4155615bd',
            endpoint: 'sdk.iad-03.braze.com',
            enableLogging: true,
            initialized: false
        };
    </script>
</head>
<body>
    <!-- Keep existing body content -->

    <script>
        // Modified Braze Initialization
        document.addEventListener('braze.SDKLoaded', () => {
            try {
                console.log('Braze SDK loaded, initializing...');
                
                braze.initialize(window.brazeConfig.apiKey, {
                    baseUrl: `https://${window.brazeConfig.endpoint}`,
                    serviceWorkerLocation: '/sw.js',
                    enableLogging: true,
                    sessionTimeoutInSeconds: 30,
                    noCookies: true
                });

                // Verify initialization
                const checkInitialized = setInterval(() => {
                    if (braze.isInitialized()) {
                        clearInterval(checkInitialized);
                        window.brazeConfig.initialized = true;
                        braze.openSession();
                        updateStatus('Braze initialized successfully', 'success');
                        console.log('Braze fully initialized');
                    }
                }, 100);

                // Timeout after 10 seconds
                setTimeout(() => {
                    if (!window.brazeConfig.initialized) {
                        clearInterval(checkInitialized);
                        throw new Error('Initialization timeout');
                    }
                }, 10000);

            } catch (error) {
                console.error('Initialization error:', error);
                updateStatus(`Initialization failed: ${error.message}`, 'error');
            }
        });

        // Add this status update function
        function updateStatus(text, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = text;
            statusEl.style.color = type === 'error' ? 'red' : 'inherit';
            statusEl.style.fontWeight = type === 'success' ? 'bold' : 'normal';
        }
    </script>
</body>
</html>
