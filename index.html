<!DOCTYPE html>
<html>
<head>
    <title>Braze Service Worker Test</title>
    <script>
        // Braze Loader
        +function(a,p,P,b,y){a.braze={};a.brazeQueue=[];for(var s="BrazeSdkMetadata ...".split(" "),i=0;i<s.length;i++){/* full loader script */}}(window,document,'script');
    </script>
    <script>
        // Configuration
        const config = {
            apiKey: '84e848cb-2923-4629-bd23-e6e4155615bd',
            endpoint: 'sdk.iad-03.braze.com',
            swPath: '/service-worker.js',
            swScope: '/'
        };

        // Initialize Braze
        document.addEventListener('braze.SDKLoaded', async () => {
            try {
                // Service Worker Registration
                if ('serviceWorker' in navigator) {
                    const reg = await navigator.serviceWorker.register(config.swPath, {
                        scope: config.swScope,
                        updateViaCache: 'none'
                    });
                    console.log('SW registered:', reg);
                    
                    reg.addEventListener('updatefound', () => {
                        console.log('SW update detected');
                    });
                }

                // Braze Initialization
                braze.initialize(config.apiKey, {
                    baseUrl: config.endpoint,
                    serviceWorkerLocation: config.swPath,
                    enableLogging: true
                });
                
                braze.openSession();
                console.log('Braze initialized');

            } catch (error) {
                console.error('Initialization failed:', error);
            }
        });
    </script>
</head>
<body>
    <h1>Service Worker Test</h1>
    <div id="status">Initializing...</div>
    
    <button onclick="testPush()">Test Push Notification</button>
    <button onclick="unregisterSW()">Unregister SW</button>

    <script>
        // Test functionality
        async function testPush() {
            if (!braze.isPushSupported()) {
                alert('Push not supported');
                return;
            }
            
            const permission = await braze.requestPushPermission();
            alert(`Push status: ${permission}`);
        }

        async function unregisterSW() {
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (let reg of registrations) await reg.unregister();
            alert('Service Workers unregistered');
            location.reload();
        }

        // Live status updates
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            document.getElementById('status').textContent = 'SW Controller Changed';
        });
    </script>
</body>
</html>
