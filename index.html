<!DOCTYPE html>
<html>
<head>
    <title>Braze Initialization Fix</title>
    <!-- Braze Configuration -->
    <script type="text/javascript">
        window.brazeConfig = {
            apiKey: '84e848cb-2923-4629-bd23-e6e4155615bd',
            endpoint: 'sdk.iad-03.braze.com',
            enableLogging: true
        };
    </script>
</head>
<body>
    <div id="loginSection">
        <h2>User Login</h2>
        <input type="text" id="userId" placeholder="User ID" required>
        <input type="email" id="userEmail" placeholder="Email" required>
        <button id="loginButton" disabled>Login</button>
        <p id="status">Initializing Braze SDK...</p>
    </div>

    <script>
        // Braze Initialization Promise
        const brazeInitialization = new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://js.appboycdn.com/web-sdk/4.7.2/braze.min.js';
            script.async = true;
            
            script.onload = () => {
                braze.initialize(window.brazeConfig.apiKey, {
                    baseUrl: window.brazeConfig.endpoint,
                    enableLogging: window.brazeConfig.enableLogging,
                    serviceWorkerLocation: "/service-worker.js"
                });
                
                braze.openSession();
                console.log('Braze SDK initialized');
                document.getElementById('status').textContent = 'Ready to login!';
                document.getElementById('loginButton').disabled = false;
                resolve();
            };

            script.onerror = () => {
                reject(new Error('Failed to load Braze SDK'));
            };

            document.head.appendChild(script);
        });

        // Login function with initialization check
        async function loginUser() {
            try {
                // Wait for SDK initialization
                await brazeInitialization;

                const userId = document.getElementById('userId').value;
                const userEmail = document.getElementById('userEmail').value;

                if (!userId || !userEmail) {
                    throw new Error('Please fill in all fields');
                }

                // Braze operations
                braze.changeUser(userId);
                braze.getUser().setEmail(userEmail);
                braze.logCustomEvent("user_login", {
                    login_method: "email",
                    user_id: userId
                });

                alert('Login successful! Data sent to Braze.');
                console.log('Braze user:', braze.getUser());
                
            } catch (error) {
                console.error('Login failed:', error);
                alert(`Error: ${error.message}`);
            }
        }

        // Assign login function to button
        document.getElementById('loginButton').onclick = loginUser;
    </script>
</body>
</html>
