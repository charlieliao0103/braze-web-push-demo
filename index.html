<!DOCTYPE html>
<html>
<head>
    <title>Braze Initialization Fix</title>
    <!-- Braze Loader Script with Error Handling -->
    <script type="text/javascript">
        (function() {
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.async = true;
            script.src = 'https://js.appboycdn.com/web-sdk/5.8/braze.min.js';
            
            // Error handling for script load
            script.onerror = function() {
                console.error('Failed to load Braze SDK');
                document.getElementById('status').textContent = 'Error loading Braze SDK';
                document.getElementById('status').style.color = 'red';
            };
            
            document.head.appendChild(script);
        })();
    </script>
    
    <!-- Braze Configuration -->
    <script type="text/javascript">
        window.brazeConfig = {
            apiKey: '84e848cb-2923-4629-bd23-e6e4155615bd',        // Replace with actual key
            endpoint: 'sdk.iad-03.braze.com', // Replace with actual endpoint
            enableLogging: true,
            serviceWorkerLocation: '/service-worker.js'
        };
    </script>
</head>
<body>
    <div id="loginSection">
        <h2>Braze Integration</h2>
        <div id="status">Initializing Braze SDK...</div>
        <button id="loginBtn" disabled>Login</button>
    </div>

    // Test Braze endpoint connectivity
    const testBrazeConnection = async () => {
      try {
        const response = await fetch(`https://${window.brazeConfig.endpoint}/healthz`);
        console.log('Braze endpoint response:', response.status);
      } catch (error) {
        console.error('Connection test failed:', error);
      }
    };
    testBrazeConnection();
    
    
    <script>
    document.addEventListener('braze.SDKLoaded', async () => {
      try {
        // 1. Initialize core SDK
        braze.initialize(window.brazeConfig.apiKey, {
          baseUrl: `https://${window.brazeConfig.endpoint}`,
          enableLogging: true,
          sessionTimeoutInSeconds: 30,
          noCookies: true, // Try if third-party cookies are blocked
          serviceWorkerLocation: '/service-worker.js'
        });
    
        // 2. Verify initialization
        await new Promise((resolve, reject) => {
          const checkInitialization = setInterval(() => {
            if (braze.isInitialized()) {
              clearInterval(checkInitialization);
              resolve();
            }
          }, 100);
          
          setTimeout(() => {
            clearInterval(checkInitialization);
            reject(new Error('Initialization timeout'));
          }, 5000);
        });
    
        // 3. Post-initialization setup
        braze.openSession();
        console.log('Braze initialized successfully');
        
      } catch (error) {
        console.error('Initialization failed:', error);
      }
    });
    </script>
</body>
</html>
