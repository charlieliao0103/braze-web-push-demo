<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Braze Final Solution</title>
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self';
                   connect-src 'self' https://*.braze.com;
                   script-src 'self' 'unsafe-inline' https://js.appboycdn.com;
                   worker-src 'self' blob:;
                   style-src 'self' 'unsafe-inline'">
    
    <!-- Braze Loader -->
    <script>
        (function(){
            var brazeLoader = document.createElement('script');
            brazeLoader.src = 'https://js.appboycdn.com/web-sdk/5.8/braze.min.js';
            brazeLoader.async = true;
            document.head.appendChild(brazeLoader);
        })();
    </script>

    <!-- Configuration -->
    <script type="text/javascript">
        window.brazeConfig = {
            apiKey: '84e848cb-2923-4629-bd23-e6e4155615bd',
            endpoint: 'sdk.iad-03.braze.com',
            enableLogging: true
        };
    </script>
</head>
<body>
    <div id="container">
        <h1>Braze Integration</h1>
        <div id="status">Initializing...</div>
        
        <div class="section">
            <h2>Connection Test</h2>
            <button onclick="runConnectionTest()">Test Connection</button>
            <div id="testResults"></div>
        </div>
    </div>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js', { scope: '/' })
                    .then(reg => {
                        console.log('SW registered');
                        reg.update();
                    })
                    .catch(err => console.error('SW registration failed:', err));
            });
        }

        // Braze Initialization
        document.addEventListener('braze.SDKLoaded', () => {
            braze.initialize(window.brazeConfig.apiKey, {
                baseUrl: `https://${window.brazeConfig.endpoint}`,
                serviceWorkerLocation: '/sw.js',
                enableLogging: true
            });
            
            braze.openSession();
            document.getElementById('status').textContent = 'Ready';
        });

        // Connection Test
        async function runConnectionTest() {
            const results = document.getElementById('testResults');
            results.innerHTML = '';
            
            // Test Braze Connection
            try {
                const response = await fetch(`https://${window.brazeConfig.endpoint}/healthz`);
                results.innerHTML += `<div class="test-success">✅ Connected to Braze servers</div>`;
            } catch (error) {
                results.innerHTML += `<div class="test-fail">❌ Connection failed: ${error.message}</div>`;
            }
        }
    </script>

    <style>
        #container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #eee;
        }
        .test-success {
            color: green;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid green;
        }
        .test-fail {
            color: red;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid red;
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            background: #f0f0f0;
        }
    </style>
</body>
</html>
