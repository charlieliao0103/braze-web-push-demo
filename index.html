<!DOCTYPE html>
<html>
<head>
    <title>Braze Initialization Fix</title>
    
    <!-- Braze Loader Script with Error Handling -->
    <script type="text/javascript">
        (function() {
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.async = true;
            script.src = 'https://js.appboycdn.com/web-sdk/5.8/braze.min.js';
            
            // Error handling for script load
            script.onerror = function() {
                console.error('Failed to load Braze SDK');
                document.getElementById('status').textContent = 'Error loading Braze SDK';
                document.getElementById('status').style.color = 'red';
            };
            
            document.head.appendChild(script);
        })();
    </script>

    <!-- Braze Configuration -->
    <script type="text/javascript">
        window.brazeConfig = {
            apiKey: '84e848cb-2923-4629-bd23-e6e4155615bd',        // Replace with actual key
            endpoint: 'sdk.iad-03.braze.com', // Replace with actual endpoint
            enableLogging: true,
            serviceWorkerLocation: '/service-worker.js'
        };
    </script>
</head>
<body>
    <div id="loginSection">
        <h2>Braze Integration</h2>
        <div id="status">Initializing Braze SDK...</div>
        <button id="loginBtn" disabled>Login</button>
    </div>

    <script>
        // Debugging initialization
        let initializationTimeout;
        const MAX_INIT_TIME = 5000; // 5 seconds timeout

        // 1. SDK Loaded Event Handler
        document.addEventListener('braze.SDKLoaded', function() {
            console.log('Braze SDK loaded, initializing...');
            clearTimeout(initializationTimeout);
            
            try {
                braze.initialize(window.brazeConfig.apiKey, {
                    baseUrl: window.brazeConfig.endpoint,
                    enableLogging: window.brazeConfig.enableLogging,
                    serviceWorkerLocation: window.brazeConfig.serviceWorkerLocation
                });
                
                braze.openSession();
                console.log('Braze initialized successfully');
                updateUIStatus('Braze initialized!', 'green');
                document.getElementById('loginBtn').disabled = false;
            } catch (error) {
                console.error('Initialization error:', error);
                updateUIStatus('Initialization failed', 'red');
            }
        });

        // 2. Timeout Fallback
        initializationTimeout = setTimeout(function() {
            if (!document.getElementById('loginBtn').disabled) return;
            console.error('Braze initialization timeout');
            updateUIStatus('Initialization timeout - check network', 'orange');
        }, MAX_INIT_TIME);

        // 3. Status Updater
        function updateUIStatus(message, color) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.style.color = color || 'black';
        }

        // 4. Login Handler
        document.getElementById('loginBtn').addEventListener('click', function() {
            if (!braze.isInitialized()) {
                alert('Braze not initialized yet!');
                return;
            }
            
            // Your login logic here
            braze.changeUser('test_user');
            braze.logCustomEvent('test_event');
            alert('Action performed successfully!');
        });

        // 5. Service Worker Verification
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                console.log('Service Workers registered:', registrations.length);
                registrations.forEach(registration => {
                    console.log('Scope:', registration.scope);
                });
            });
        }

        // 6. Debugging Helpers
        console.log('Braze initialization started at:', new Date().toISOString());
        setInterval(() => {
            console.log('Current initialization state:', {
                brazeLoaded: typeof braze !== 'undefined',
                isInitialized: braze ? braze.isInitialized() : false,
                queueLength: braze ? braze.brazeQueue.length : 0
            });
        }, 1000);
    </script>
</body>
</html>
